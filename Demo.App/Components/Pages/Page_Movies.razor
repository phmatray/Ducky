@page "/movies"
@inherits R3duxComponent<MovieState>

<PageTitle>R3dux - Movies</PageTitle>
<MudStack>
  <p class="chapter">Example</p>
  <MudText Typo="Typo.h3">Movies</MudText>
  <p>
    Creates a simple movie example using the R3dux state management library for predictable state handling,
    featuring loading state and error handling for displaying movies.
  </p>
</MudStack>

<article>
  <header>5 more recent movies</header>
  @if (ErrorMessage != null)
  {
    <p><strong>@ErrorMessage</strong></p>
  }
  else if (IsLoading)
  {
    <p><strong>Loading movies...</strong></p>
  }
  else
  {
    <MudSimpleTable>
      <thead>
      <tr>
        <th>Title</th>
        <th>Director</th>
        <th>Year</th>
        <th>Duration</th>
      </tr>
      </thead>
      <tbody>
      @foreach (var movie in Movies)
      {
        <tr>
          <td>@movie.Title</td>
          <td>@movie.Director</td>
          <td>@movie.Year</td>
          <td>@movie.Duration</td>
        </tr>
      }
      </tbody>
    </MudSimpleTable>
  }
  <footer style="display: flex; justify-content: space-between;">
    @if (IsLoading)
    {
      <MudButton Variant="Variant.Outlined" aria-busy="true" Disabled>Please wait...</MudButton>
    }
    else
    {
      <MudButton Variant="Variant.Outlined" OnClick="LoadMovies">Reload Movies</MudButton>
    }
    <div>
      <MudButton
        Variant="Variant.Outlined"
        Disabled="@(State.Pagination.CurrentPage == 1)"
        OnClick="PreviousPage">
        Previous
      </MudButton>
      <span style="margin: 0 1rem;">
        Page @State.Pagination.CurrentPage of @State.Pagination.TotalPages
      </span>
      <MudButton
        Variant="Variant.Outlined"
        Disabled="@(State.Pagination.CurrentPage == State.Pagination.TotalPages)"
        OnClick="NextPage">
        Next
      </MudButton>
    </div>
  </footer>
</article>


@code {
  
  private IImmutableList<Movie> Movies
    => State.SelectMoviesByYear();
  
  private bool IsLoading
    => State.IsLoading;
  
  private string? ErrorMessage
    => State.ErrorMessage;

  protected override void OnInitialized()
  {
    base.OnInitialized();

    if (Movies.Count == 0)
    {
      LoadMovies();
    }
  }
  
  private void LoadMovies()
    => Dispatch(new LoadMovies());
  
  private void PreviousPage()
  {
    if (State.Pagination.CurrentPage > 1)
    {
      Dispatch(new SetCurrentPage(State.Pagination.CurrentPage - 1));
      LoadMovies();
    }
  }

  private void NextPage()
  {
    if (State.Pagination.CurrentPage < State.Pagination.TotalPages)
    {
      Dispatch(new SetCurrentPage(State.Pagination.CurrentPage + 1));
      LoadMovies();
    }
  }

}