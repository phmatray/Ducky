@using Ducky.Generator.WebApp.Services
@inject IAppStoreService AppStoreService
@inject ISnackbar Snackbar

<MudDialog maxwidth="MaxWidth.ExtraLarge" fullwidth="true">
    <DialogContent>
        @if (_appStore == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <MudContainer MaxWidth="MaxWidth.False" Class="pa-0">
                <MudGrid>
                    <!-- Left Panel - Store Builder -->
                    <MudItem xs="12" lg="8">
                        <MudPaper Class="pa-4" Elevation="1" Style="min-height: 80vh;">
                            <!-- Store Header -->
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-4">
                                <MudStack>
                                    <MudText Typo="Typo.h4">@_appStore.Name</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary">@_appStore.Namespace</MudText>
                                </MudStack>
                                <MudStack Row="true" Spacing="2">
                                    <MudButton Variant="Variant.Outlined" 
                                               StartIcon="@Icons.Material.Filled.Build"
                                               OnClick="ShowTemplates">
                                        Templates
                                    </MudButton>
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary"
                                               StartIcon="@Icons.Material.Filled.Add"
                                               OnClick="AddStateSliceAsync">
                                        Add State Slice
                                    </MudButton>
                                </MudStack>
                            </MudStack>

                            <!-- Progress Indicator -->
                            <MudTimeline TimelineOrientation="TimelineOrientation.Horizontal" Class="mb-6">
                                <MudTimelineItem Color="@(_appStore.StateSlices.Any() ? Color.Success : Color.Default)" 
                                                 Variant="@(_appStore.StateSlices.Any() ? Variant.Filled : Variant.Outlined)">
                                    <MudText Typo="Typo.caption">State Slices</MudText>
                                    <MudText Typo="Typo.body2">@_appStore.StateSlices.Count</MudText>
                                </MudTimelineItem>
                                <MudTimelineItem Color="@(_appStore.StateSlices.Any(s => s.Actions.Any()) ? Color.Success : Color.Default)"
                                                 Variant="@(_appStore.StateSlices.Any(s => s.Actions.Any()) ? Variant.Filled : Variant.Outlined)">
                                    <MudText Typo="Typo.caption">Actions</MudText>
                                    <MudText Typo="Typo.body2">@_appStore.StateSlices.Sum(s => s.Actions.Count)</MudText>
                                </MudTimelineItem>
                                <MudTimelineItem Color="@(_appStore.StateSlices.Any(s => s.Effects.Any()) ? Color.Success : Color.Default)"
                                                 Variant="@(_appStore.StateSlices.Any(s => s.Effects.Any()) ? Variant.Filled : Variant.Outlined)">
                                    <MudText Typo="Typo.caption">Effects</MudText>
                                    <MudText Typo="Typo.body2">@_appStore.StateSlices.Sum(s => s.Effects.Count)</MudText>
                                </MudTimelineItem>
                                <MudTimelineItem Color="@(IsReadyToGenerate ? Color.Success : Color.Default)"
                                                 Variant="@(IsReadyToGenerate ? Variant.Filled : Variant.Outlined)">
                                    <MudText Typo="Typo.caption">Ready</MudText>
                                    <MudIcon Icon="@(IsReadyToGenerate ? Icons.Material.Filled.Check : Icons.Material.Filled.Schedule)" />
                                </MudTimelineItem>
                            </MudTimeline>

                            <!-- State Slices Builder -->
                            @if (!_appStore.StateSlices.Any())
                            {
                                <!-- Empty State with Quick Start -->
                                <MudPaper Class="pa-8 text-center" Elevation="0" Style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 16px;">
                                    <MudIcon Icon="@Icons.Material.Filled.Architecture" Size="Size.Large" Color="Color.Primary" Class="mb-3" />
                                    <MudText Typo="Typo.h5" Class="mb-2">Design Your Store Architecture</MudText>
                                    <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mb-4">
                                        Start by adding state slices - these represent different areas of your application state.
                                    </MudText>
                                    
                                    <!-- Quick Start Templates -->
                                    <MudGrid Justify="Justify.Center" Spacing="2" Class="mt-4">
                                        <MudItem xs="12" sm="4">
                                            <MudButton Variant="Variant.Outlined" 
                                                       Color="Color.Primary"
                                                       FullWidth="true"
                                                       StartIcon="@Icons.Material.Filled.ListAlt"
                                                       OnClick="() => CreateFromTemplateAsync(StoreTemplate.TodoApp)">
                                                Todo App
                                            </MudButton>
                                        </MudItem>
                                        <MudItem xs="12" sm="4">
                                            <MudButton Variant="Variant.Outlined" 
                                                       Color="Color.Success"
                                                       FullWidth="true"
                                                       StartIcon="@Icons.Material.Filled.ShoppingCart"
                                                       OnClick="() => CreateFromTemplateAsync(StoreTemplate.ECommerce)">
                                                E-Commerce
                                            </MudButton>
                                        </MudItem>
                                        <MudItem xs="12" sm="4">
                                            <MudButton Variant="Variant.Outlined" 
                                                       Color="Color.Warning"
                                                       FullWidth="true"
                                                       StartIcon="@Icons.Material.Filled.Dashboard"
                                                       OnClick="() => CreateFromTemplateAsync(StoreTemplate.Dashboard)">
                                                Dashboard
                                            </MudButton>
                                        </MudItem>
                                    </MudGrid>
                                    
                                    <MudDivider Class="my-4" />
                                    
                                    <MudButton Variant="Variant.Filled" 
                                               Color="Color.Primary"
                                               Size="Size.Large"
                                               StartIcon="@Icons.Material.Filled.Create"
                                               OnClick="AddStateSliceAsync">
                                        Start From Scratch
                                    </MudButton>
                                </MudPaper>
                            }
                            else
                            {
                                <!-- State Slices Cards -->
                                <MudStack Spacing="3">
                                    @foreach (var slice in _appStore.StateSlices)
                                    {
                                        <MudCard Elevation="2" Class="mud-card-hover">
                                            <MudCardHeader>
                                                <CardHeaderContent>
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.DataObject" Color="Color.Primary" />
                                                        <MudText Typo="Typo.h6">@slice.Name</MudText>
                                                        <MudSpacer />
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Info" Variant="Variant.Outlined">
                                                            @slice.Actions.Count actions
                                                        </MudChip>
                                                        <MudChip T="string" Size="Size.Small" Color="Color.Warning" Variant="Variant.Outlined">
                                                            @slice.Effects.Count effects
                                                        </MudChip>
                                                    </MudStack>
                                                </CardHeaderContent>
                                                <CardHeaderActions>
                                                    <MudMenu Icon="@Icons.Material.Filled.MoreVert" Color="Color.Default" Dense="true">
                                                        <MudMenuItem Icon="@Icons.Material.Filled.Edit" OnClick="@(() => EditStateSlice(slice))">
                                                            Edit
                                                        </MudMenuItem>
                                                        <MudMenuItem Icon="@Icons.Material.Filled.ContentCopy" OnClick="@(() => DuplicateStateSlice(slice))">
                                                            Duplicate
                                                        </MudMenuItem>
                                                        <MudDivider />
                                                        <MudMenuItem Icon="@Icons.Material.Filled.Delete" OnClick="@(() => DeleteStateSliceAsync(slice))">
                                                            <MudText Color="Color.Error">Delete</MudText>
                                                        </MudMenuItem>
                                                    </MudMenu>
                                                </CardHeaderActions>
                                            </MudCardHeader>
                                            
                                            <MudCardContent>
                                                @if (!string.IsNullOrEmpty(slice.Description))
                                                {
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-3">
                                                        @slice.Description
                                                    </MudText>
                                                }

                                                <!-- Quick Actions Grid -->
                                                <MudGrid Spacing="2">
                                                    <!-- Actions Column -->
                                                    <MudItem xs="12" md="6">
                                                        <MudStack Spacing="2">
                                                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                                <MudText Typo="Typo.subtitle1" Color="Color.Primary">
                                                                    <MudIcon Icon="@Icons.Material.Filled.FlashOn" Size="Size.Small" Class="mr-1" />
                                                                    Actions
                                                                </MudText>
                                                                <MudButton Size="Size.Small" 
                                                                           Variant="Variant.Text" 
                                                                           StartIcon="@Icons.Material.Filled.Add"
                                                                           OnClick="@(() => AddActionAsync(slice))">
                                                                    Add
                                                                </MudButton>
                                                            </MudStack>
                                                            
                                                            @if (slice.Actions.Any())
                                                            {
                                                                <MudStack Spacing="1">
                                                                    @foreach (var action in slice.Actions.Take(3))
                                                                    {
                                                                        <MudChip T="string" 
                                                                                 Size="Size.Small" 
                                                                                 Color="Color.Default" 
                                                                                 Variant="Variant.Text"
                                                                                 Icon="@Icons.Material.Filled.PlayArrow">
                                                                            @action.Name
                                                                        </MudChip>
                                                                    }
                                                                    @if (slice.Actions.Count > 3)
                                                                    {
                                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                            +@(slice.Actions.Count - 3) more...
                                                                        </MudText>
                                                                    }
                                                                </MudStack>
                                                            }
                                                            else
                                                            {
                                                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                                    No actions yet
                                                                </MudText>
                                                            }
                                                        </MudStack>
                                                    </MudItem>

                                                    <!-- Effects Column -->
                                                    <MudItem xs="12" md="6">
                                                        <MudStack Spacing="2">
                                                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                                                <MudText Typo="Typo.subtitle1" Color="Color.Warning">
                                                                    <MudIcon Icon="@Icons.Material.Filled.Psychology" Size="Size.Small" Class="mr-1" />
                                                                    Effects
                                                                </MudText>
                                                                <MudButton Size="Size.Small" 
                                                                           Variant="Variant.Text" 
                                                                           StartIcon="@Icons.Material.Filled.Add"
                                                                           OnClick="@(() => AddEffectAsync(slice))">
                                                                    Add
                                                                </MudButton>
                                                            </MudStack>
                                                            
                                                            @if (slice.Effects.Any())
                                                            {
                                                                <MudStack Spacing="1">
                                                                    @foreach (var effect in slice.Effects.Take(3))
                                                                    {
                                                                        <MudChip T="string" 
                                                                                 Size="Size.Small" 
                                                                                 Color="Color.Warning" 
                                                                                 Variant="Variant.Text"
                                                                                 Icon="@Icons.Material.Filled.AutoAwesome">
                                                                            @effect.Name
                                                                        </MudChip>
                                                                    }
                                                                    @if (slice.Effects.Count > 3)
                                                                    {
                                                                        <MudText Typo="Typo.caption" Color="Color.Secondary">
                                                                            +@(slice.Effects.Count - 3) more...
                                                                        </MudText>
                                                                    }
                                                                </MudStack>
                                                            }
                                                            else
                                                            {
                                                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                                    No effects yet
                                                                </MudText>
                                                            }
                                                        </MudStack>
                                                    </MudItem>
                                                </MudGrid>
                                            </MudCardContent>
                                        </MudCard>
                                    }
                                </MudStack>
                            }
                        </MudPaper>
                    </MudItem>

                    <!-- Right Panel - Live Preview & Actions -->
                    <MudItem xs="12" lg="4">
                        <MudPaper Class="pa-4" Elevation="2" Style="min-height: 80vh; position: sticky; top: 0;">
                            <MudTabs Elevation="0" Rounded="true" PanelClass="pa-0">
                                <!-- Preview Tab -->
                                <MudTabPanel Text="Preview" Icon="@Icons.Material.Filled.Visibility">
                                    <MudStack Spacing="3" Class="mt-3">
                                        <MudText Typo="Typo.h6">
                                            <MudIcon Icon="@Icons.Material.Filled.Code" Class="mr-2" />
                                            Generated Structure
                                        </MudText>
                                        
                                        @if (_appStore.StateSlices.Any())
                                        {
                                            <MudTreeView T="string">
                                                <MudTreeViewItem Text="@_appStore.Namespace" Icon="@Icons.Material.Filled.Folder">
                                                    @foreach (var slice in _appStore.StateSlices)
                                                    {
                                                        <MudTreeViewItem Text="@slice.Name" Icon="@Icons.Material.Filled.DataObject">
                                                            <MudTreeViewItem Text="State.cs" Icon="@Icons.Material.Filled.Schema" />
                                                            <MudTreeViewItem Text="Actions.cs" Icon="@Icons.Material.Filled.FlashOn" />
                                                            <MudTreeViewItem Text="Reducers.cs" Icon="@Icons.Material.Filled.Settings" />
                                                            @if (slice.Effects.Any())
                                                            {
                                                                <MudTreeViewItem Text="Effects.cs" Icon="@Icons.Material.Filled.Psychology" />
                                                            }
                                                        </MudTreeViewItem>
                                                    }
                                                    <MudTreeViewItem Text="Store.cs" Icon="@Icons.Material.Filled.Store" />
                                                </MudTreeViewItem>
                                            </MudTreeView>
                                        }
                                        else
                                        {
                                            <MudText Typo="Typo.body2" Color="Color.Secondary">
                                                Add state slices to see the generated structure
                                            </MudText>
                                        }
                                    </MudStack>
                                </MudTabPanel>

                                <!-- Settings Tab -->
                                <MudTabPanel Text="Settings" Icon="@Icons.Material.Filled.Settings">
                                    <MudStack Spacing="3" Class="mt-3">
                                        <MudForm @bind-IsValid="@_isValid">
                                            <MudTextField @bind-Value="_appStore.Name" 
                                                          Label="App Store Name" 
                                                          Required="true"
                                                          MaxLength="100"
                                                          Variant="Variant.Outlined" />
                                            
                                            <MudTextField @bind-Value="_appStore.Description" 
                                                          Label="Description" 
                                                          Lines="3"
                                                          MaxLength="500"
                                                          Variant="Variant.Outlined" />
                                            
                                            <MudTextField @bind-Value="_appStore.Namespace" 
                                                          Label="Namespace" 
                                                          Required="true"
                                                          MaxLength="100"
                                                          Variant="Variant.Outlined" />
                                        </MudForm>
                                    </MudStack>
                                </MudTabPanel>

                                <!-- Analytics Tab -->
                                <MudTabPanel Text="Analytics" Icon="@Icons.Material.Filled.Analytics">
                                    <MudStack Spacing="3" Class="mt-3">
                                        <MudText Typo="Typo.h6">Store Metrics</MudText>
                                        
                                        <MudGrid>
                                            <MudItem xs="6">
                                                <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: #f5f5f5;">
                                                    <MudText Typo="Typo.h4" Color="Color.Primary">@_appStore.StateSlices.Count</MudText>
                                                    <MudText Typo="Typo.body2">State Slices</MudText>
                                                </MudPaper>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: #f5f5f5;">
                                                    <MudText Typo="Typo.h4" Color="Color.Success">@_appStore.StateSlices.Sum(s => s.Actions.Count)</MudText>
                                                    <MudText Typo="Typo.body2">Total Actions</MudText>
                                                </MudPaper>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: #f5f5f5;">
                                                    <MudText Typo="Typo.h4" Color="Color.Warning">@_appStore.StateSlices.Sum(s => s.Effects.Count)</MudText>
                                                    <MudText Typo="Typo.body2">Total Effects</MudText>
                                                </MudPaper>
                                            </MudItem>
                                            <MudItem xs="6">
                                                <MudPaper Class="pa-3 text-center" Elevation="0" Style="background-color: #f5f5f5;">
                                                    <MudText Typo="Typo.h4" Color="Color.Info">@GetComplexityScore()</MudText>
                                                    <MudText Typo="Typo.body2">Complexity</MudText>
                                                </MudPaper>
                                            </MudItem>
                                        </MudGrid>

                                        <MudDivider />

                                        <MudText Typo="Typo.subtitle1">Recommendations</MudText>
                                        <MudStack Spacing="2">
                                            @if (!_appStore.StateSlices.Any())
                                            {
                                                <MudAlert Severity="Severity.Info" Dense="true">
                                                    Start by adding your first state slice
                                                </MudAlert>
                                            }
                                            @if (_appStore.StateSlices.Any(s => !s.Actions.Any()))
                                            {
                                                <MudAlert Severity="Severity.Warning" Dense="true">
                                                    Some state slices have no actions
                                                </MudAlert>
                                            }
                                            @if (_appStore.StateSlices.Sum(s => s.Actions.Count) > 0 && !_appStore.StateSlices.Any(s => s.Effects.Any()))
                                            {
                                                <MudAlert Severity="Severity.Info" Dense="true">
                                                    Consider adding effects for side effects
                                                </MudAlert>
                                            }
                                            @if (GetComplexityScore() > 50)
                                            {
                                                <MudAlert Severity="Severity.Warning" Dense="true">
                                                    High complexity - consider splitting store
                                                </MudAlert>
                                            }
                                        </MudStack>
                                    </MudStack>
                                </MudTabPanel>
                            </MudTabs>
                        </MudPaper>
                    </MudItem>
                </MudGrid>
            </MudContainer>
        }
    </DialogContent>
    
    <DialogActions>
        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Style="width: 100%;">
            <MudStack Row="true" Spacing="2">
                <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
                <MudButton Color="Color.Secondary" 
                           Variant="Variant.Outlined" 
                           StartIcon="@Icons.Material.Filled.Visibility"
                           OnClick="PreviewCode"
                           Disabled="@(!_appStore?.StateSlices.Any() ?? true)">
                    Preview Code
                </MudButton>
            </MudStack>
            
            <MudStack Row="true" Spacing="2">
                <MudButton Color="Color.Success" 
                           Variant="Variant.Filled" 
                           StartIcon="@Icons.Material.Filled.Code"
                           OnClick="GenerateCodeAsync"
                           Disabled="@(!IsReadyToGenerate || _isSaving)">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Generating...</span>
                    }
                    else
                    {
                        <span>Generate Code</span>
                    }
                </MudButton>
                <MudButton Color="Color.Primary" 
                           Variant="Variant.Filled" 
                           OnClick="SaveAsync"
                           Disabled="@(!_isValid || _isSaving)">
                    @if (_isSaving)
                    {
                        <MudProgressCircular Size="Size.Small" Indeterminate="true" Class="mr-2" />
                        <span>Saving...</span>
                    }
                    else
                    {
                        <span>Save Changes</span>
                    }
                </MudButton>
            </MudStack>
        </MudStack>
    </DialogActions>
</MudDialog>

<style>
    .mud-card-hover {
        transition: all 0.3s ease;
    }
    .mud-card-hover:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.12) !important;
    }
</style>