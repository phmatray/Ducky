@inject ISnackbar Snackbar

<MudDialog maxwidth="MaxWidth.Large" fullwidth="true">
    <TitleContent>
        <MudText Typo="Typo.h6">
            <MudIcon Icon="@Icons.Material.Filled.Architecture" Class="mr-2" />
            @(_stateSlice?.Name ?? "New State Slice") Designer
        </MudText>
    </TitleContent>
    
    <DialogContent>
        <MudContainer MaxWidth="MaxWidth.False" Class="pa-0">
            <MudGrid>
                <!-- Left Panel - State Design -->
                <MudItem xs="12" lg="7">
                    <MudStack Spacing="4">
                        <!-- Basic Info -->
                        <MudPaper Class="pa-4" Elevation="1">
                            <MudText Typo="Typo.h6" Class="mb-3">
                                <MudIcon Icon="@Icons.Material.Filled.Info" Class="mr-2" />
                                Basic Information
                            </MudText>
                            <MudForm @bind-IsValid="@_isValid">
                                <MudGrid>
                                    <MudItem xs="12" md="6">
                                        <MudTextField @bind-Value="_sliceName" 
                                                      Label="Slice Name" 
                                                      Required="true"
                                                      Variant="Variant.Outlined"
                                                      HelperText="e.g., Users, Products, Orders" />
                                    </MudItem>
                                    <MudItem xs="12" md="6">
                                        <MudSelect T="string" Value="_selectedTemplate" 
                                                   Label="Template" 
                                                   Variant="Variant.Outlined"
                                                   ValueChanged="ApplyTemplate">
                                            <MudSelectItem Value="@("custom")">Custom</MudSelectItem>
                                            <MudSelectItem Value="@("crud")">CRUD Operations</MudSelectItem>
                                            <MudSelectItem Value="@("async-data")">Async Data Loading</MudSelectItem>
                                            <MudSelectItem Value="@("form")">Form Management</MudSelectItem>
                                            <MudSelectItem Value="@("list-with-filter")">List with Filtering</MudSelectItem>
                                        </MudSelect>
                                    </MudItem>
                                    <MudItem xs="12">
                                        <MudTextField @bind-Value="_sliceDescription" 
                                                      Label="Description" 
                                                      Lines="2"
                                                      Variant="Variant.Outlined"
                                                      HelperText="Describe what this state slice manages" />
                                    </MudItem>
                                </MudGrid>
                            </MudForm>
                        </MudPaper>

                        <!-- State Properties Designer -->
                        <MudPaper Class="pa-4" Elevation="1">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.DataObject" Class="mr-2" />
                                    State Properties
                                </MudText>
                                <MudButton Variant="Variant.Outlined" 
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Size="Size.Small"
                                           OnClick="AddStateProperty">
                                    Add Property
                                </MudButton>
                            </MudStack>

                            @if (_stateProperties.Any())
                            {
                                <MudStack Spacing="2">
                                    @for (int i = 0; i < _stateProperties.Count; i++)
                                    {
                                        var propIndex = i;
                                        var prop = _stateProperties[propIndex];
                                        
                                        <MudPaper Class="pa-3" Elevation="0" Style="background-color: #f9f9f9;">
                                            <MudGrid alignitems="Center">
                                                <MudItem xs="3">
                                                    <MudTextField @bind-Value="prop.Name"
                                                                  Label="Property Name"
                                                                  Variant="Variant.Outlined"
                                                                  size="Size.Small" />
                                                </MudItem>
                                                <MudItem xs="3">
                                                    <MudSelect T="string" @bind-Value="prop.Type"
                                                               Label="Type"
                                                               Variant="Variant.Outlined"
                                                               size="Size.Small">
                                                        <MudSelectItem Value="@("bool")">bool</MudSelectItem>
                                                        <MudSelectItem Value="@("string")">string</MudSelectItem>
                                                        <MudSelectItem Value="@("string?")">string?</MudSelectItem>
                                                        <MudSelectItem Value="@("int")">int</MudSelectItem>
                                                        <MudSelectItem Value="@("decimal")">decimal</MudSelectItem>
                                                        <MudSelectItem Value="@("DateTime")">DateTime</MudSelectItem>
                                                        <MudSelectItem Value="@("List<T>")">List&lt;T&gt;</MudSelectItem>
                                                        <MudSelectItem Value="@("NormalizedState<K,V>")">NormalizedState&lt;K,V&gt;</MudSelectItem>
                                                        <MudSelectItem Value="@("custom")">Custom Type</MudSelectItem>
                                                    </MudSelect>
                                                </MudItem>
                                                <MudItem xs="4">
                                                    <MudTextField @bind-Value="prop.DefaultValue"
                                                                  Label="Default Value"
                                                                  Variant="Variant.Outlined"
                                                                  size="Size.Small"
                                                                  HelperText="e.g., false, null, new()" />
                                                </MudItem>
                                                <MudItem xs="2" Class="text-right">
                                                    <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                                                   Size="Size.Small"
                                                                   Color="Color.Error"
                                                                   OnClick="() => RemoveStateProperty(propIndex)" />
                                                </MudItem>
                                            </MudGrid>
                                        </MudPaper>
                                    }
                                </MudStack>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    Add properties to define your state structure. Common properties include IsLoading, Error, and Data.
                                </MudAlert>
                            }
                        </MudPaper>

                        <!-- Actions Designer -->
                        <MudPaper Class="pa-4" Elevation="1">
                            <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center" Class="mb-3">
                                <MudText Typo="Typo.h6">
                                    <MudIcon Icon="@Icons.Material.Filled.FlashOn" Class="mr-2" />
                                    Actions
                                </MudText>
                                <MudButton Variant="Variant.Outlined" 
                                           StartIcon="@Icons.Material.Filled.Add"
                                           Size="Size.Small"
                                           OnClick="AddAction">
                                    Add Action
                                </MudButton>
                            </MudStack>

                            @if (_actions.Any())
                            {
                                <MudStack Spacing="2">
                                    @for (int i = 0; i < _actions.Count; i++)
                                    {
                                        var actionIndex = i;
                                        var action = _actions[actionIndex];
                                        
                                        <MudExpansionPanels Elevation="0">
                                            <MudExpansionPanel>
                                                <TitleContent>
                                                    <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                                        <MudIcon Icon="@Icons.Material.Filled.PlayArrow" />
                                                        <MudText Typo="Typo.subtitle1">@action.Name</MudText>
                                                        <MudSpacer />
                                                        <MudChip T="string" Size="Size.Small" 
                                                                 Color="@(action.IsAsync ? Color.Warning : Color.Default)">
                                                            @(action.IsAsync ? "Async" : "Sync")
                                                        </MudChip>
                                                    </MudStack>
                                                </TitleContent>
                                                <ChildContent>
                                                    <MudGrid>
                                                        <MudItem xs="12" md="6">
                                                            <MudTextField @bind-Value="action.Name"
                                                                          Label="Action Name"
                                                                          Variant="Variant.Outlined"
                                                                          HelperText="e.g., LoadData, UpdateUser" />
                                                        </MudItem>
                                                        <MudItem xs="12" md="6">
                                                            <MudTextField @bind-Value="action.PayloadType"
                                                                          Label="Payload Type"
                                                                          Variant="Variant.Outlined"
                                                                          HelperText="e.g., { Id: int }, User" />
                                                        </MudItem>
                                                        <MudItem xs="12">
                                                            <MudTextField @bind-Value="action.Description"
                                                                          Label="Description"
                                                                          Lines="2"
                                                                          Variant="Variant.Outlined" />
                                                        </MudItem>
                                                        <MudItem xs="12">
                                                            <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
                                                                <MudSwitch @bind-Value="action.IsAsync" 
                                                                           Label="Async Action" 
                                                                           Color="Color.Primary" />
                                                                <MudSpacer />
                                                                <MudButton Variant="Variant.Text" 
                                                                           Color="Color.Error"
                                                                           StartIcon="@Icons.Material.Filled.Delete"
                                                                           OnClick="() => RemoveAction(actionIndex)">
                                                                    Remove
                                                                </MudButton>
                                                            </MudStack>
                                                        </MudItem>
                                                    </MudGrid>
                                                </ChildContent>
                                            </MudExpansionPanel>
                                        </MudExpansionPanels>
                                    }
                                </MudStack>
                            }
                            else
                            {
                                <MudAlert Severity="Severity.Info" Dense="true">
                                    Add actions to define how users can interact with this state.
                                </MudAlert>
                            }
                        </MudPaper>
                    </MudStack>
                </MudItem>

                <!-- Right Panel - Preview -->
                <MudItem xs="12" lg="5">
                    <MudPaper Class="pa-4" Elevation="2" Style="position: sticky; top: 0;">
                        <MudTabs Elevation="0" Rounded="true" PanelClass="pa-0">
                            <!-- State Preview -->
                            <MudTabPanel Text="State" Icon="@Icons.Material.Filled.DataObject">
                                <MudStack Spacing="3" Class="mt-3">
                                    <MudText Typo="Typo.h6">Generated State</MudText>
                                    
                                    <MudPaper Class="pa-3" Elevation="0" Style="background-color: #1e1e1e; border-radius: 8px;">
                                        <pre style="margin: 0; color: #d4d4d4; font-family: 'Cascadia Code', monospace; font-size: 12px; line-height: 1.4;">@GenerateStatePreview()</pre>
                                    </MudPaper>
                                </MudStack>
                            </MudTabPanel>

                            <!-- Actions Preview -->
                            <MudTabPanel Text="Actions" Icon="@Icons.Material.Filled.FlashOn">
                                <MudStack Spacing="3" Class="mt-3">
                                    <MudText Typo="Typo.h6">Generated Actions</MudText>
                                    
                                    <MudPaper Class="pa-3" Elevation="0" Style="background-color: #1e1e1e; border-radius: 8px;">
                                        <pre style="margin: 0; color: #d4d4d4; font-family: 'Cascadia Code', monospace; font-size: 12px; line-height: 1.4;">@GenerateActionsPreview()</pre>
                                    </MudPaper>
                                </MudStack>
                            </MudTabPanel>

                            <!-- Reducers Preview -->
                            <MudTabPanel Text="Reducers" Icon="@Icons.Material.Filled.Settings">
                                <MudStack Spacing="3" Class="mt-3">
                                    <MudText Typo="Typo.h6">Generated Reducers</MudText>
                                    
                                    <MudPaper Class="pa-3" Elevation="0" Style="background-color: #1e1e1e; border-radius: 8px;">
                                        <pre style="margin: 0; color: #d4d4d4; font-family: 'Cascadia Code', monospace; font-size: 12px; line-height: 1.4;">@GenerateReducersPreview()</pre>
                                    </MudPaper>
                                </MudStack>
                            </MudTabPanel>
                        </MudTabs>
                    </MudPaper>
                </MudItem>
            </MudGrid>
        </MudContainer>
    </DialogContent>
    
    <DialogActions>
        <MudButton OnClick="Cancel" Variant="Variant.Text">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="Save"
                   Disabled="@(!_isValid || string.IsNullOrWhiteSpace(_sliceName))">
            @(_stateSlice == null ? "Create" : "Update") State Slice
        </MudButton>
    </DialogActions>
</MudDialog>