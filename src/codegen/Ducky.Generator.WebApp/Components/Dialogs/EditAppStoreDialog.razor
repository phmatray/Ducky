@using Ducky.Generator.WebApp.Services
@using System.Text.Json
@inject IAppStoreService AppStoreService
@inject ISnackbar Snackbar

<MudDialog>
    <DialogContent>
        @if (_appStore == null)
        {
            <MudProgressCircular Indeterminate="true" />
        }
        else
        {
            <MudTabs Elevation="2" Rounded="true" PanelClass="pa-6">
                <!-- App Store Details Tab -->
                <MudTabPanel Text="Details">
                    <MudForm @bind-IsValid="@_isValid">
                        <MudTextField @bind-Value="_appStore.Name" 
                                      Label="App Store Name" 
                                      Required="true"
                                      MaxLength="100" />
                        
                        <MudTextField @bind-Value="_appStore.Description" 
                                      Label="Description" 
                                      Lines="3"
                                      MaxLength="500" />
                        
                        <MudTextField @bind-Value="_appStore.Namespace" 
                                      Label="Namespace" 
                                      Required="true"
                                      MaxLength="100" />
                    </MudForm>
                </MudTabPanel>

                <!-- State Slices Tab -->
                <MudTabPanel Text="State Slices">
                    <MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.h6">State Slices</MudText>
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" 
                                       StartIcon="@Icons.Material.Filled.Add"
                                       OnClick="AddStateSliceAsync">
                                Add State Slice
                            </MudButton>
                        </MudStack>

                        @if (!_appStore.StateSlices.Any())
                        {
                            <MudPaper Class="pa-4 text-center">
                                <MudText Typo="Typo.body2" Color="Color.Secondary">
                                    No state slices yet. Add your first state slice to get started.
                                </MudText>
                            </MudPaper>
                        }
                        else
                        {
                            @foreach (var slice in _appStore.StateSlices)
                            {
                                <MudExpansionPanels>
                                    <MudExpansionPanel Text="@slice.Name">
                                        <TitleContent>
                                            <div style="display: flex; align-items: center;">
                                                <MudIcon Icon="@Icons.Material.Filled.DataObject" class="mr-3"></MudIcon>
                                                <MudText>@slice.Name</MudText>
                                                <MudSpacer />
                                                <MudChip T="string" Size="Size.Small" Color="Color.Info">
                                                    @slice.Actions.Count actions
                                                </MudChip>
                                                <MudChip T="string" Size="Size.Small" Color="Color.Warning" Class="ml-2">
                                                    @slice.Effects.Count effects
                                                </MudChip>
                                            </div>
                                        </TitleContent>
                                        <ChildContent>
                                            <MudStack>
                                                @if (!string.IsNullOrEmpty(slice.Description))
                                                {
                                                    <MudText Typo="Typo.body2">@slice.Description</MudText>
                                                }

                                                <!-- Actions Section -->
                                                <MudDivider />
                                                <MudText Typo="Typo.h6">Actions</MudText>
                                                @if (!slice.Actions.Any())
                                                {
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">No actions defined</MudText>
                                                }
                                                else
                                                {
                                                    <MudSimpleTable Style="overflow-x: auto;">
                                                        <thead>
                                                            <tr>
                                                                <th>Name</th>
                                                                <th>Payload Type</th>
                                                                <th>Async</th>
                                                                <th>Description</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var action in slice.Actions)
                                                            {
                                                                <tr>
                                                                    <td>@action.Name</td>
                                                                    <td><code>@action.PayloadType</code></td>
                                                                    <td>@(action.IsAsync ? "Yes" : "No")</td>
                                                                    <td>@action.Description</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </MudSimpleTable>
                                                }
                                                <MudButton Variant="Variant.Outlined" Size="Size.Small" 
                                                           StartIcon="@Icons.Material.Filled.Add"
                                                           OnClick="@(() => AddActionAsync(slice))">
                                                    Add Action
                                                </MudButton>

                                                <!-- Effects Section -->
                                                <MudDivider />
                                                <MudText Typo="Typo.h6">Effects</MudText>
                                                @if (!slice.Effects.Any())
                                                {
                                                    <MudText Typo="Typo.body2" Color="Color.Secondary">No effects defined</MudText>
                                                }
                                                else
                                                {
                                                    <MudSimpleTable Style="overflow-x: auto;">
                                                        <thead>
                                                            <tr>
                                                                <th>Name</th>
                                                                <th>Type</th>
                                                                <th>Trigger Actions</th>
                                                                <th>Description</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            @foreach (var effect in slice.Effects)
                                                            {
                                                                <tr>
                                                                    <td>@effect.Name</td>
                                                                    <td>@effect.ImplementationType</td>
                                                                    <td>
                                                                        @{
                                                                            var triggers = JsonSerializer.Deserialize<List<string>>(effect.TriggerActions);
                                                                        }
                                                                        @string.Join(", ", triggers!)
                                                                    </td>
                                                                    <td>@effect.Description</td>
                                                                </tr>
                                                            }
                                                        </tbody>
                                                    </MudSimpleTable>
                                                }
                                                <MudButton Variant="Variant.Outlined" Size="Size.Small" 
                                                           StartIcon="@Icons.Material.Filled.Add"
                                                           OnClick="@(() => AddEffectAsync(slice))">
                                                    Add Effect
                                                </MudButton>
                                            </MudStack>
                                        </ChildContent>
                                    </MudExpansionPanel>
                                </MudExpansionPanels>
                            }
                        }
                    </MudStack>
                </MudTabPanel>
            </MudTabs>
        }
    </DialogContent>
    <DialogActions>
        <MudButton OnClick="Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary" 
                   Variant="Variant.Filled" 
                   OnClick="SaveAsync"
                   Disabled="@(!_isValid || _isSaving)">
            @if (_isSaving)
            {
                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                <span style="margin-left: 8px;">Saving...</span>
            }
            else
            {
                <span>Save</span>
            }
        </MudButton>
    </DialogActions>
</MudDialog>