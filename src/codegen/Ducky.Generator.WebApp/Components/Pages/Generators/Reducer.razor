@page "/generator/reducer"
@using Ducky.Generator.Core
@inject ReducerGenerator Generator
@inject ISnackbar Snackbar
@inject IJSRuntime Js

<PageTitle>Reducer Generator - Ducky Code Generator</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large">
    <!-- Header with Breadcrumbs -->
    <MudBreadcrumbs Items="_breadcrumbs" Class="mb-4" />
    
    <MudGrid>
        <!-- Configuration Panel -->
        <MudItem xs="12" md="5">
            <MudPaper Class="pa-4" Elevation="2">
                <MudText Typo="Typo.h5" GutterBottom="true">
                    <MudIcon Icon="@Icons.Material.Filled.Transform" Class="mr-2" />
                    Reducer Generator
                </MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary" GutterBottom="true">
                    Generate strongly-typed reducers for your Ducky state management with action handling.
                </MudText>
                
                <MudDivider Class="my-4" />
                
                <MudForm @ref="_form" @bind-IsValid="@_isValid">
                    <MudStack Spacing="3">
                        <!-- Basic Configuration -->
                        <MudTextField @bind-Value="_options.Namespace" 
                                      Label="Namespace" 
                                      Variant="Variant.Outlined"
                                      HelperText="The C# namespace for your reducers"
                                      Required="true" />
                        
                        <!-- Reducers List -->
                        <MudText Typo="Typo.h6" Class="mt-4">Reducers</MudText>
                        
                        @foreach (var reducer in _options.Reducers)
                        {
                            <MudCard Outlined="true" Class="pa-3">
                                <MudStack>
                                    <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                                        <MudTextField Value="@GetReducerClassNameWrapper(reducer)" 
                                                      ValueChanged="@((string value) => UpdateReducerClassName(reducer, value))"
                                                      Label="Reducer Class Name" 
                                                      Variant="Variant.Outlined"
                                                      Style="flex: 1;"
                                                      Required="true" />
                                        <MudIconButton Icon="@Icons.Material.Filled.Delete" 
                                                       Color="Color.Error" 
                                                       Size="Size.Small"
                                                       title="Remove Reducer"
                                                       OnClick="@(() => RemoveReducer(reducer))" />
                                    </MudStack>
                                    
                                    <MudTextField Value="@GetStateTypeWrapper(reducer)" 
                                                  ValueChanged="@((string value) => UpdateStateType(reducer, value))"
                                                  Label="State Type" 
                                                  Variant="Variant.Outlined"
                                                  HelperText="The state type this reducer handles (e.g., TodoState, CounterState)"
                                                  Required="true" />
                                    
                                    <!-- Actions -->
                                    <MudText Typo="Typo.subtitle2">Handled Actions</MudText>
                                    @foreach (var action in reducer.Actions.ToList())
                                    {
                                        <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                                            <MudTextField Value="@action" 
                                                          Label="Action Type" 
                                                          Variant="Variant.Outlined"
                                                          Style="flex: 1;"
                                                          ReadOnly="true" />
                                            <MudIconButton Icon="@Icons.Material.Filled.Remove" 
                                                           Color="Color.Error" 
                                                           Size="Size.Small"
                                                           OnClick="@(() => RemoveAction(reducer, action))" />
                                        </MudStack>
                                    }
                                    
                                    <MudStack Row="true" Spacing="2">
                                        <MudTextField @bind-Value="_newActionName" 
                                                      Label="New Action Type" 
                                                      Variant="Variant.Outlined"
                                                      Style="flex: 1;"
                                                      Placeholder="e.g., AddTodoAction"
                                                      @onkeypress="@((e) => { if (e.Key == "Enter") AddAction(reducer); })" />
                                        <MudButton Variant="Variant.Text" 
                                                   StartIcon="@Icons.Material.Filled.Add"
                                                   Size="Size.Small"
                                                   Disabled="@string.IsNullOrWhiteSpace(_newActionName)"
                                                   OnClick="@(() => AddAction(reducer))">
                                            Add Action
                                        </MudButton>
                                    </MudStack>
                                </MudStack>
                            </MudCard>
                        }
                        
                        <MudButton Variant="Variant.Outlined" 
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.Add"
                                   FullWidth="true"
                                   OnClick="AddReducer">
                            Add New Reducer
                        </MudButton>
                        
                        <!-- Generate Button -->
                        <MudButton Variant="Variant.Filled" 
                                   Color="Color.Primary"
                                   StartIcon="@Icons.Material.Filled.AutoMode"
                                   FullWidth="true"
                                   Size="Size.Large"
                                   Disabled="@(!_isValid || !_options.Reducers.Any())"
                                   OnClick="GenerateAsync">
                            Generate Reducers
                        </MudButton>
                    </MudStack>
                </MudForm>
            </MudPaper>
        </MudItem>
        
        <!-- Generated Code Panel -->
        <MudItem xs="12" md="7">
            @if (!string.IsNullOrEmpty(_generatedCode))
            {
                <MudPaper Class="pa-4" Elevation="2">
                    <MudStack>
                        <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                            <MudText Typo="Typo.h5">Generated Code</MudText>
                            <MudStack Row="true" Spacing="2">
                                <MudButton Variant="Variant.Outlined" 
                                           StartIcon="@Icons.Material.Filled.ContentCopy"
                                           OnClick="CopyToClipboardAsync">
                                    Copy
                                </MudButton>
                                <MudButton Variant="Variant.Filled" 
                                           Color="Color.Secondary"
                                           StartIcon="@Icons.Material.Filled.Download"
                                           OnClick="DownloadCodeAsync">
                                    Download
                                </MudButton>
                            </MudStack>
                        </MudStack>
                        
                        <MudDivider Class="my-3" />
                        
                        <MudPaper Class="pa-3" Style="background-color: #1e1e1e; border-radius: 8px; overflow: auto; max-height: 70vh;">
                            <pre style="margin: 0; color: #d4d4d4; font-family: 'Cascadia Code', 'Courier New', monospace; font-size: 13px;">@_generatedCode</pre>
                        </MudPaper>
                    </MudStack>
                </MudPaper>
            }
            else
            {
                <MudPaper Class="pa-8 text-center" Elevation="0" Style="background-color: #f5f5f5; height: 100%;">
                    <MudIcon Icon="@Icons.Material.Filled.Code" Size="Size.Large" Color="Color.Secondary" />
                    <MudText Typo="Typo.h6" Class="mt-3">No Code Generated Yet</MudText>
                    <MudText Typo="Typo.body2" Color="Color.Secondary">
                        Configure your reducers and click "Generate Reducers" to see the code.
                    </MudText>
                </MudPaper>
            }
        </MudItem>
    </MudGrid>
    
    <!-- Example Usage -->
    <MudPaper Class="pa-4 mt-6" Elevation="1">
        <MudText Typo="Typo.h6" GutterBottom="true">Example Usage</MudText>
        <MudText Typo="Typo.body2" GutterBottom="true">
            Reducers handle state transitions in response to actions in your Ducky application:
        </MudText>
        <MudPaper Class="pa-3 mt-3" Style="background-color: #f5f5f5;">
            <pre style="margin: 0; font-family: 'Cascadia Code', monospace; font-size: 12px;">// Using generated reducers with SliceReducers
var todoReducers = new SliceReducers&lt;TodoState&gt;(new TodoState())
    .On&lt;AddTodoAction&gt;(TodoReducers.HandleAddTodo)
    .On&lt;ToggleTodoAction&gt;(TodoReducers.HandleToggleTodo);

// Register in store builder
services.AddDuckyStore(builder =>
{
    builder.AddSlice(todoReducers);
});</pre>
        </MudPaper>
    </MudPaper>
</MudContainer>