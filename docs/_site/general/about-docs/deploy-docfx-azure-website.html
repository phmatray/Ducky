<!DOCTYPE html>
<!--[if IE]><![endif]-->
<html>
  <!-- Standard head.tmpl.partial from 'default' template. v2.63.1
   When you have rendering issues, check if this is the latest version
   with 'docfx template export default -o <path-to-a-local-folder>' -->

  <head>
    <meta charset="utf-8">
      <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
      <title>Deploy the DocFx Documentation website to an Azure Website automatically | R3dux Documentation </title>
      <meta name="viewport" content="width=device-width">
      <meta name="title" content="Deploy the DocFx Documentation website to an Azure Website automatically | R3dux Documentation ">
    
      <link rel="shortcut icon" href="../../images/favicon.ico">
      <link rel="stylesheet" href="../../styles/docfx.vendor.min.css">
      <link rel="stylesheet" href="../../styles/docfx.css">
      <link rel="stylesheet" href="../../styles/main.css">
      <!-- Added support for copy code button. Together with script in scripts.tmpl.partial -->
      <link rel="stylesheet" href="../../styles/copy-code-button.css">
      <meta property="docfx:navrel" content="../../toc.html">
      <meta property="docfx:tocrel" content="../toc.html">
    
    <meta property="docfx:rel" content="../../">
    <meta property="docfx:newtab" content="true">
  </head>
  <body data-spy="scroll" data-target="#affix" data-offset="120">
    <div id="wrapper">
      <header>

        <nav id="autocollapse" class="navbar navbar-inverse ng-scope" role="navigation">
          <div class="container">
            <div class="navbar-header">
              <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
              </button>

              <a class="navbar-brand" href="../../index.html">
                <img id="logo" class="svg" src="../../images/logo.png" alt="R3dux Documentation">
              </a>
            </div>
            <div class="collapse navbar-collapse" id="navbar">
              <form class="navbar-form navbar-right" role="search" id="search">
                <div class="form-group">
                  <input type="text" class="form-control" id="search-query" placeholder="Search" autocomplete="off">
                </div>
              </form>
            </div>
          </div>
        </nav>

        <div class="subnav navbar navbar-default">
          <div class="container hide-when-search" id="breadcrumb">
            <ul class="breadcrumb">
              <li></li>
            </ul>
          </div>
        </div>
      </header>
      <div class="container body-content">

        <div id="search-results">
          <div class="search-list">Search Results for <span></span></div>
          <div class="sr-items">
            <p><i class="glyphicon glyphicon-refresh index-loading"></i></p>
          </div>
          <ul id="pagination" data-first="First" data-prev="Previous" data-next="Next" data-last="Last"></ul>
        </div>
      </div>
      <div role="main" class="container body-content hide-when-search">

        <div class="sidenav hide-when-search">
          <a class="btn toc-toggle collapse" data-toggle="collapse" href="#sidetoggle" aria-expanded="false" aria-controls="sidetoggle">Show / Hide Table of Contents</a>
          <div class="sidetoggle collapse" id="sidetoggle">
            <div id="sidetoc"></div>
          </div>
        </div>
        <div class="article row grid-right">
          <div class="col-md-10">
            <article class="content wrap" id="_content" data-uid="">
<h1 id="deploy-the-docfx-documentation-website-to-an-azure-website-automatically">Deploy the DocFx Documentation website to an Azure Website automatically</h1>

<p>In the <a href="README.html">README</a> the process is described to generate content of a documentation website using DocFx. This document describes how to setup an Azure Website to host the content and automate the deployment to it using a pipeline in Azure DevOps.</p>
<p>The <a href="https://github.com/mtirionMSFT/DocFxQuickStart/tree/master/QuickStart">QuickStart folder</a> that is provided for a quick setup of DocFx generation also contains the files explained in this document. Especially the <strong>.pipelines</strong> and <strong>infrastructure</strong> folders.</p>
<p>The following steps can be followed when using the QuickStart folder. In the <strong>infrastructure</strong> folder you can find the Terraform files to create the website in an Azure environment. Out of the box, the script will create a website where the documentation content can be deployed to.</p>
<h2 id="1-install-terraform">1. Install Terraform</h2>
<p>You can use tools like <a href="https://chocolatey.org/">Chocolatey</a> to install Terraform:</p>
<pre><code class="lang-shell">choco install terraform
</code></pre>
<h2 id="2-set-the-proper-variables">2. Set the proper variables</h2>
<div class="IMPORTANT">
<h5>Important</h5>
<p>Make sure you modify the value of the <strong>app_name</strong>, <strong>rg_name</strong> and <strong>rg_location</strong> variables. The <em>app_name</em> value is appended by <strong>azurewebsites.net</strong> and must be unique. Otherwise the script will fail that it cannot create the website.</p>
</div>
<p>In the QuickStart folder setup, authentication is disabled. If you want that enabled, make sure you have create an <em>Application</em> in the Azure AD and have the <em>client ID</em>. This client id must be set as the value of the <strong>client_id</strong> variable in <em>variables.tf</em>. In the <em>main.tf</em> make sure you uncomment the authentication settings in the <em>app-service</em>. For more information see <a href="https://docs.microsoft.com/en-us/azure/app-service/configure-authentication-provider-aad">Configure Azure AD authentication - Azure App Service</a>.</p>
<p>If you want to set a custom domain for your documentation website with an SSL certificate you have to do some extra steps. You have to create a <em>Key Vault</em> and store the certificate there. Next step is to uncomment and set the values in <em>variables.tf</em>. You also have to uncomment the necessary steps in <em>main.tf</em>. All is indicated by comment-boxes. For more information see <a href="https://docs.microsoft.com/en-us/azure/app-service/configure-ssl-certificate">Add a TLS/SSL certificate in Azure App Service</a>.</p>
<p>Some extra information on SSL certificate, custom domain and Azure App Service can be found in the following paragraphs. If you are familiar with that or don't need it, go ahead and continue with <a href="#3-deploy-azure-resources-from-your-local-machine">Step 3</a>.</p>
<h3 id="ssl-certificate">SSL Certificate</h3>
<p>To secure a website with a custom domain name and a certificate, you can find the steps to take in the article <a href="https://docs.microsoft.com/en-us/azure/app-service/configure-ssl-certificate">Add a TLS/SSL certificate in Azure App Service</a>. That article also contains a description of ways to obtain a certificate and the requirements for a certificate. Usually you'll get a certificate from the customers IT department. If you want to start with a development certificate to test the process, you can create one yourself. You can do that in PowerShell with the script below. Replace:</p>
<ul>
<li><strong>[YOUR DOMAIN]</strong> with the domain you would like to register, e.g. <code>docs.somewhere.com</code></li>
<li><strong>[PASSWORD]</strong> with a password of the certificate. It's required for uploading a certificate in the Key Vault to have a password. You'll need this password in that step.</li>
<li><strong>[FILENAME]</strong> for the output file name of the certificate. You can even insert the path here where it should be store on your machine.</li>
</ul>
<p>You can store this script in a PowerShell script file (ps1 extension).</p>
<pre><code class="lang-powershell">$cert = New-SelfSignedCertificate -CertStoreLocation cert:\currentuser\my -Subject &quot;cn=[YOUR DOMAIN]&quot; -DnsName &quot;[YOUR DOMAIN]&quot;
$pwd = ConvertTo-SecureString -String '[PASSWORD]' -Force -AsPlainText
$path = 'cert:\currentuser\my\' + $cert.thumbprint
Export-PfxCertificate -cert $path -FilePath [FILENAME].pfx -Password $pwd
</code></pre>
<p>The certificate needs to be stored in the common Key Vault. Go to <code>Settings &gt; Certificates</code> in the left menu of the Key Vault and click <code>Generate/Import</code>. Provide these details:</p>
<ul>
<li><p>Method of Certificate Creation: <code>Import</code></p>
</li>
<li><p>Certificate name: e.g. <code>ssl-certificate</code></p>
</li>
<li><p>Upload Certificate File: select the file on disc for this.</p>
</li>
<li><p>Password: this is the [PASSWORD] we reference earlier.</p>
</li>
</ul>
<h3 id="custom-domain-registration">Custom domain registration</h3>
<p>To use a custom domain a few things need to be done. The process in the Azure portal is described in the article <a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-custom-domain">Tutorial: Map an existing custom DNS name to Azure App Service</a>. An important part is described under the header <a href="https://docs.microsoft.com/en-us/azure/app-service/app-service-web-tutorial-custom-domain#get-a-domain-verification-id">Get a domain verification ID</a>. This ID needs to be registered with the DNS description as a TXT record.</p>
<p>Important to know is that this <code>Custom Domain Verification ID</code> is the same for all web resources in the same Azure subscription. See <a href="https://stackoverflow.com/questions/64309200/is-the-custom-domain-verification-shared-across-an-azure-subscription">this StackOverflow issue</a>. This means that this ID needs to be registered only once for one Azure Subscription. And this enables (re)creation of an App Service with the custom domain though script.</p>
<h3 id="add-get-permissions-for-microsoft-azure-app-service">Add Get-permissions for Microsoft Azure App Service</h3>
<p>The Azure App Service needs to access the Key Vault to get the certificate. This is needed for the first run, but also when the certificate is renewed in the Key Vault. For this purpose the Azure App Service accesses the Key Vault with the App Service resource provided identity. This identity can be found with the service principal name <strong>abfa0a7c-a6b6-4736-8310-5855508787cd</strong> or <strong>Microsoft Azure App Service</strong> and is of type <strong>Application</strong>. This ID is the same for all Azure subscriptions. It needs to have Get-permissions on secrets and certificates. For more information see this article <a href="https://docs.microsoft.com/en-us/azure/app-service/configure-ssl-certificate#import-a-certificate-from-key-vault">Import a certificate from Key Vault</a>.</p>
<h3 id="add-the-custom-domain-and-ssl-certificate-to-the-app-service">Add the custom domain and SSL certificate to the App Service</h3>
<p>Once we have the SSL certificate and there is a complete DNS registration as described, we can uncomment the code in the Terraform script from the QuickStart folder to attach this to the App Service. In this script you need to reference the certificate in the common Key Vault and use it in the custom hostname binding. The custom hostname is assigned in the script as well. The settings <code>ssl_state</code> needs to be <code>SniEnabled</code> if you're using an SSL certificate. Now the creation of the authenticated website with a custom domain is automated.</p>
<h2 id="3-deploy-azure-resources-from-your-local-machine">3. Deploy Azure resources from your local machine</h2>
<p>Open up a command prompt. For the commands to be executed, you need to have a connection to your Azure subscription. This can be done using <a href="https://docs.microsoft.com/en-us/cli/azure/install-azure-cli-windows?tabs=azure-cli">Azure Cli</a>. Type this command:</p>
<pre><code class="lang-shell">az login
</code></pre>
<p>This will use the web browser to login to your account. You can check the connected subscription with this command:</p>
<pre><code class="lang-shell">az account show
</code></pre>
<p>If you have to change to another subscription, use this command where you replace <em>[id]</em> with the id of the subscription to select:</p>
<pre><code class="lang-shell">az account set --subscription [id]
</code></pre>
<p>Once this is done run this command to initialize:</p>
<pre><code class="lang-shell">terraform init
</code></pre>
<p>Now you can run the command to plan what the script will do. You run this command every time changes are made to the terraform scripts:</p>
<pre><code class="lang-shell">terraform plan
</code></pre>
<p>Inspect the result shown. If that is what you expect, apply these changes with this command:</p>
<pre><code class="lang-shell">terraform apply
</code></pre>
<p>When asked for approval, type &quot;yes&quot; and ENTER. You can also add the <em>-auto-approve</em> flag to the apply command.</p>
<p>The deployment using Terraform is not included in the pipeline from the QuickStart folder as described in the next step, as that asks for more configuration. But of course that can always be added.</p>
<h2 id="4-deploy-the-website-from-a-pipeline">4. Deploy the website from a pipeline</h2>
<p>The best way to create the resources and deploy to it, is to do this automatically in a pipeline. For this purpose the <strong>.pipelines/documentation.yml</strong> pipeline is provided. This pipeline is built for an Azure DevOps environment. Create a pipeline and reference this YAML file.</p>
<div class="IMPORTANT">
<h5>Important</h5>
<p>the QuickStart folder contains a web.config that is needed for deployment to IIS or Azure App Service. This enables the use of the json file for search requests. If you don't have this in place, the search of text will never return anything and result in 404's under the hood.</p>
</div>
<p>You have to create a Service Connection in your DevOps environment to connect to the Azure Subscription you want to deploy to.</p>
<div class="IMPORTANT">
<h5>Important</h5>
<p>set the variables <strong>AzureConnectionName</strong> to the name of the Service Connection and the <strong>AzureAppServiceName</strong> to the name you determined in the <em>infrastructure/variables.tf</em>.</p>
</div>
<p>In the QuickStart folder the pipeline uses <code>master</code> as trigger, which means that any push being done to master triggers the pipeline. You will probably change this to another branch.</p>

</article>
          </div>

          <div class="hidden-sm col-md-2" role="complementary">
            <div class="sideaffix">
              <div class="contribution">
                <ul class="nav">
                  <li>
                    <a href="https://github.com/phmatray/R3dux/blob/features/documentation/docs/general/about-docs/deploy-docfx-azure-website.md/#L1" class="contribution-link">Edit this page</a>
                  </li>
                </ul>
              </div>
              <nav class="bs-docs-sidebar hidden-print hidden-xs hidden-sm affix" id="affix">
                <h5>In this article</h5>
                <div></div>
              </nav>
            </div>
          </div>
        </div>
      </div>

      <footer>
        <div class="grad-bottom"></div>
        <div class="footer">
          <div class="container">
            <span class="pull-right">
              <a href="#top">Back to top</a>
            </span>
      
      <span>Generated by <strong>DocFX</strong></span>
          </div>
        </div>
      </footer>
    </div>
    <!-- Standard scripts.tmpl.partial from 'default' template. v2.63.1
     When you have rendering issues, check if this is the latest version
     with 'docfx template export default -o <path-to-a-local-folder>' -->

    <script type="text/javascript" src="../../styles/docfx.vendor.min.js"></script>
    <script type="text/javascript" src="../../styles/docfx.js"></script>
    <script type="text/javascript" src="../../styles/main.js"></script>

    <!-- Added support for copy code button. Together with script in scripts.tmpl.partial -->
    <script type="text/javascript" src="../../styles/copy-code-button.js"></script>

    <!-- Support for diagrams (Mermaid). See https://mermaid.js.org/intro/n00b-gettingStarted.html -->
    <script type="module">
        import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.esm.min.mjs';
        mermaid.initialize({ startOnLoad: true });
    </script>  </body>
</html>
