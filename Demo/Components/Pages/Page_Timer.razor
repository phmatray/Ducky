@page "/timer"
@inherits R3duxComponent<TimerState>

<h3>Timer</h3>

<div>
  <div>Time: @Time seconds</div>
  <button @onclick="ToggleTimer">
    @(IsRunning ? "Stop" : "Start")
  </button>
  <button @onclick="Reset">Reset</button>
</div>

@code {

  private int Time => State.Time;
  private bool IsRunning => State.IsRunning;
  
  private System.Timers.Timer? _timer;

  protected override void OnInitialized()
  {
    if (IsRunning)
    {
      StartTimer();
    }
  }

  private void StartTimer()
  {
    if (_timer == null)
    {
      _timer = new System.Timers.Timer(1000);
      _timer.Elapsed += OnTimerElapsed;
      _timer.Start();
    }
  }

  private void StopTimer()
  {
    if (_timer != null)
    {
      _timer.Stop();
      _timer.Elapsed -= OnTimerElapsed;
      _timer.Dispose();
      _timer = null;
    }
  }

  private async void OnTimerElapsed(object? sender, System.Timers.ElapsedEventArgs e)
  {
    await InvokeAsync(() => Dispatch(new Tick()));
  }

  private void ToggleTimer()
  {
    if (IsRunning)
    {
      Dispatch(new StopTimer());
      StopTimer();
    }
    else
    {
      Dispatch(new StartTimer());
      StartTimer();
    }
  }

  private void Reset()
  {
    Dispatch(new ResetTimer());
    StopTimer();
  }

}
